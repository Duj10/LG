<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Gestion LG</title>
<style>
body { font-family: Arial; margin: 20px; }
h2 { margin-top: 25px; }
.player {
    margin: 6px 0; padding: 10px; border-radius: 6px;
    border: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center;
}
.dead { opacity: 0.45; }
.btn { padding: 4px 8px; margin-left: 5px; }
.actions button { margin-right: 5px; }
</style>
</head>
<body>

<h2>Ajouter un joueur</h2>
<input id="name" placeholder="Nom">
<select id="roleSelect">

    <!-- Reveil nuit 1 -->
    <option value="Ange">Ange</option>
    <option value="Chien-loup">Chien-loup</option>
    <option value="Enfant sauvage">Enfant sauvage</option>
    <option value="Vieux fou">Vieux fou</option>
    <option value="Cupidon">Cupidon</option>
    <option value="Chasseur">Chasseur</option>

    <!-- Reveil toute kes nuit / a partir de la deuxi√®me nuit -->
    <option value="Sh√©rif">Sh√©rif</option>
    <option value="Voyante">Voyante</option>
    <option value="Garde">Garde</option>
    <option value="Croque mort">Croque mort</option>
    <option value="Cannibale">Cannibale</option>
    <option value="Renard">Renard</option>
    <option value="LG simple">Loup-garou simple</option>
    <option value="LG Infect">Infect p√®re des loups</option>
    <option value="LG Grimeur">Loup-garou grimeur</option>
    <option value="LG Craintif">Loup-garou craintif</option>
    <option value="LG Noir">Loup-garou noir</option>
    <option value="LG Blanc">Loup-garou blanc</option>
    <option value="Sorci√®re">Sorci√®re</option>
    <option value="Assassin">Assassin</option>

    <!-- Pas de reveil -->
    <option value="Villageois">Villageois</option>

    <option value="Sh√©rif">Sh√©rif</option>
    <option value="Instituteur">L'instituteur</option>
    
</select>
<button onclick="addPlayer()">Ajouter</button>

<h2>Joueurs</h2>
<div style="margin-bottom:10px">
    <input id="search" placeholder="Recherche par nom..." style="margin-right:6px">
    <select id="roleFilter">
        <option value="">Tous r√¥les</option>
    </select>
    <span style="margin-left:12px">Nuit: <span id="nightDisplay">1</span></span>
    <button onclick="nextNight()" style="margin-left:6px">Nouvelle nuit</button>
    <button onclick="resetNight()" style="margin-left:6px">R√©initialiser nuit</button>
    <button onclick="exportPlayers()" style="margin-left:8px">Exporter JSON</button>
    <button onclick="document.getElementById('importFile').click()">Importer JSON</button>
    <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importPlayers(event)">
</div>
<div id="list"></div>

<script>
const ROLE_ORDER = [
    "Sh√©rif","Ange","Chien-loup","Enfant sauvage","Vieux fou","Cupidon","Chasseur",
    "Voyante","Garde","Croque mort","Cannibale","Renard",
    "LG simple","LG Infect","LG Grimeur","LG Craintif","LG Noir","LG Blanc",
    "Sorci√®re","Assassin","Villageois","Instituteur"
];

// Camps et mapping r√¥le -> camp
const CAMP_ORDER = ["Villageois","LG","Solo","Bipolaire"];
const ROLE_TO_CAMP = {
    "Villageois":"Villageois",
    "Sorci√®re":"Villageois",
    "Renard":"Villageois",
    "Vieux fou":"Villageois",
    "Chasseur":"Villageois",
    "Cupidon":"Villageois",
    "Voyante":"Villageois",
    "Garde":"Villageois",
    "Croque mort":"Villageois",
    "Instituteur":"Villageois",
    "Sh√©rif":"Villageois",

    "LG simple":"LG",
    "LG Infect":"LG",
    "LG Grimeur":"LG",
    "LG Noir":"LG",
    "LG Blanc":"LG",
    "LG Craintif":"LG",

    "Ange":"Solo",
    "Cannibale":"Solo",
    "Assassin":"Solo",

    "Chien-loup":"Bipolaire",
    "Enfant sauvage":"Bipolaire"
};

// Charger/sauvegarder joueurs
let players = JSON.parse(localStorage.getItem("lg_players") || "[]");

// nuit courante (persist√©e s√©par√©ment)
let currentNight = parseInt(localStorage.getItem("lg_currentNight") || "1", 10);
function saveNight(){ localStorage.setItem("lg_currentNight", String(currentNight)); }

// Remplir filtre de r√¥le
function populateRoleFilter(){
    const sel = document.getElementById('roleFilter');
    // populate with camps (Villageois, LG, Solo, Bipolaire)
    CAMP_ORDER.forEach(c=>{
        const opt = document.createElement('option'); opt.value = c; opt.textContent = c; sel.appendChild(opt);
    });
}

// Export / Import JSON
function exportPlayers(){
    const data = JSON.stringify(players, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'lg_players.json'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
}

function importPlayers(ev){
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
        try{
            const data = JSON.parse(reader.result);
            if(!Array.isArray(data)) throw new Error('Format invalide');
            // validation basique des entr√©es
            const validated = data.map((p, idx)=>{
                if(!p || typeof p !== 'object') throw new Error('Entr√©e '+(idx+1)+' invalide');
                if(!p.name || typeof p.name !== 'string') throw new Error('Entr√©e '+(idx+1)+' manque un nom valide');
                return {
                    name: p.name,
                    role: (p.role && typeof p.role === 'string') ? p.role : 'Villageois',
                    chienChoice: p.chienChoice || undefined,
                    angeRoleChoice: p.angeRoleChoice || undefined,
                    dechuTargetId: p.dechuTargetId || undefined,
                    extraLives: typeof p.extraLives === 'number' ? p.extraLives : 0,
                    angeProtectedId: p.angeProtectedId || undefined,
                    sheriffTargets: Array.isArray(p.sheriffTargets) ? p.sheriffTargets : [],
                    sheriffBlockedNight: typeof p.sheriffBlockedNight === 'number' ? p.sheriffBlockedNight : undefined,
                    alive: typeof p.alive === 'boolean' ? p.alive : true,
                    firstNight: !!p.firstNight,
                    lifePotionUsed: !!p.lifePotionUsed,
                    deathPotionUsed: !!p.deathPotionUsed,
                    id: p.id || undefined,
                    partnerId: p.partnerId || undefined,
                    cupidonUsed: !!p.cupidonUsed,
                    croqueUses: typeof p.croqueUses === 'number' ? p.croqueUses : 0,
                    hiddenNight: typeof p.hiddenNight === 'number' ? p.hiddenNight : undefined,
                    deathNight: typeof p.deathNight === 'number' ? p.deathNight : undefined,
                    vieuxFouRole: p.vieuxFouRole || undefined,
                    vieuxFouResurrected: !!p.vieuxFouResurrected,
                    guardProtectedNight: typeof p.guardProtectedNight === 'number' ? p.guardProtectedNight : undefined
                    ,deathKiller: typeof p.deathKiller === 'string' ? p.deathKiller : undefined
                    ,deathCause: typeof p.deathCause === 'string' ? p.deathCause : undefined
                };
            });

            if(players.length > 0){
                const replace = confirm('Il y a d√©j√† des joueurs enregistr√©s. OK = remplacer, Annuler = fusionner (ajouter)');
                if(replace){
                    players = validated;
                } else {
                    // fusion: ajouter en √©vitant doublons d'ID
                    const existingIds = new Set(players.map(p=>p.id));
                    validated.forEach(p=>{
                        if(!p.id || existingIds.has(p.id)) p.id = Date.now() + Math.floor(Math.random()*100000);
                        players.push(p);
                    });
                }
            } else {
                players = validated;
            }

            save(); render(); alert('Import r√©ussi');
        }catch(e){ alert('Import √©chou√©: '+e.message); }
    };
    reader.readAsText(file);
    // reset input
    ev.target.value = '';
}

// initialisation: remplir filtre, lier √©v√©nements et rendre
populateRoleFilter();
    document.getElementById('search').addEventListener('input', render);
    document.getElementById('roleFilter').addEventListener('change', render);
    render();
    // afficher la nuit courante au chargement
    updateNightDisplay();

// Mettre √† jour la disponibilit√© des options dans le select d'ajout
function updateRoleSelectAvailability(){
    const sel = document.getElementById('roleSelect');
    if(!sel) return;
    const used = new Set(players.map(p=>p.role));
    Array.from(sel.options).forEach(opt=>{
        // Autoriser plusieurs 'Villageois' : ne pas d√©sactiver cette option
        if(opt.value === 'Villageois') { opt.disabled = false; return; }
        // D√©sactiver les r√¥les d√©j√† utilis√©s (sauf Villageois)
        if(opt.value && used.has(opt.value)) opt.disabled = true; else opt.disabled = false;
    });
}

// --- Cupidon: selection et mise en couple ---
function startCoupleSelection(cupidId){
    // Emp√™cher si Cupidon est bloqu√© par le Sh√©rif cette nuit
    const cupidActor = players.find(p=>p.id==cupidId);
    if(cupidActor && cupidActor.sheriffBlockedNight === currentNight){ alert(cupidActor.name + ' est bloqu√© par le Sh√©rif cette nuit.'); return; }
    // cr√©er overlay
    if(document.getElementById('coupleOverlay')) return;
    const overlay = document.createElement('div');
    overlay.id = 'coupleOverlay';
    overlay.style.position = 'fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background = 'rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';

    const box = document.createElement('div');
    box.style.background = '#fff'; box.style.padding='16px'; box.style.borderRadius='8px'; box.style.maxHeight='70%'; box.style.overflow='auto'; box.style.minWidth='320px';
    const title = document.createElement('div'); title.textContent = 'S√©lectionner 2 joueurs √† mettre en couple'; title.style.fontWeight='bold'; title.style.marginBottom='8px';
    box.appendChild(title);

    const list = document.createElement('div');
    players.filter(p=>p.alive && p.id !== cupidId).forEach(p=>{
        const row = document.createElement('div');
        row.style.marginBottom='6px';
        row.innerHTML = `<label><input type="checkbox" class="coupleChoice" value="${p.id}"> ${p.name} ${p.partnerId?'<span>‚ù§Ô∏è</span>':''}</label>`;
        list.appendChild(row);
    });
    box.appendChild(list);

    const help = document.createElement('div'); help.style.marginTop='8px'; help.textContent='Choisir exactement deux joueurs.'; box.appendChild(help);
    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>{overlay.remove();};
    const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const checked = Array.from(list.querySelectorAll('.coupleChoice:checked')).map(i=>i.value);
        if(checked.length !== 2){ alert('S√©lectionnez exactement deux joueurs.'); return; }
            setCouple(checked[0], checked[1], cupidId);
        overlay.remove();
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions);

    overlay.appendChild(box); document.body.appendChild(overlay);
}

function setCouple(idA, idB, cupidId){
    const a = players.find(p=>p.id==idA); const b = players.find(p=>p.id==idB);
    if(!a || !b) { alert('Joueurs introuvables'); return; }
    // D√©faire couples pr√©c√©dents
    if(a.partnerId){ const old = players.find(p=>p.id==a.partnerId); if(old) old.partnerId = undefined; }
    if(b.partnerId){ const old = players.find(p=>p.id==b.partnerId); if(old) old.partnerId = undefined; }
    a.partnerId = b.id; b.partnerId = a.id;
    // marquer l'utilisation de Cupidon
    if(cupidId){ const cup = players.find(p=>p.id==cupidId); if(cup) cup.cupidonUsed = true; }
    save(); render();
    alert(a.name + ' et ' + b.name + ' sont maintenant en couple ‚ù§Ô∏è');
}

function save() {
    localStorage.setItem("lg_players", JSON.stringify(players));
}

function updateNightDisplay(){
    const d = document.getElementById('nightDisplay'); if(d) d.textContent = String(currentNight);
}

function nextNight(){
    currentNight += 1; saveNight(); updateNightDisplay(); alert('Nuit '+currentNight+' commenc√©e');
}

function resetNight(){
    if(!confirm('R√©initialiser la nuit √† 1 ?')) return;
    currentNight = 1; saveNight(); updateNightDisplay();
}

// Assurer que chaque joueur a un ID unique
function ensurePlayerIds() {
    players.forEach((p, i) => {
        if (!p.id) p.id = Date.now() + i;
    });
}

// Trier selon l'ordre et la case Premi√®re nuit
function render() {
    ensurePlayerIds();
    updateNightDisplay();
    const div = document.getElementById("list");
    div.innerHTML = "";

    // Appliquer filtres
    const q = document.getElementById('search') ? document.getElementById('search').value.trim().toLowerCase() : '';
    const roleFilter = document.getElementById('roleFilter') ? document.getElementById('roleFilter').value : '';

    // S√©parer morts et vivants
    const alive = players.filter(p => p.alive);
    const dead = players.filter(p => !p.alive);

    // Trier vivants selon ROLE_ORDER
    alive.sort((a,b)=>{
        // Si un Chien-loup a choisi le camp 'Loup', le consid√©rer comme 'LG' pour le tri
        const campA = (a.role === 'Chien-loup' && a.chienChoice === 'Loup') ? 'LG' : (ROLE_TO_CAMP[a.role] || 'Villageois');
        const campB = (b.role === 'Chien-loup' && b.chienChoice === 'Loup') ? 'LG' : (ROLE_TO_CAMP[b.role] || 'Villageois');
        const orderCampA = CAMP_ORDER.indexOf(campA);
        const orderCampB = CAMP_ORDER.indexOf(campB);
        if(orderCampA !== orderCampB) return orderCampA - orderCampB;
        // m√™me camp -> fallback sur ROLE_ORDER
        const orderA = ROLE_ORDER.indexOf(a.role);
        const orderB = ROLE_ORDER.indexOf(b.role);
        if(a.firstNight && !b.firstNight) return 1;
        if(!a.firstNight && b.firstNight) return -1;
        return orderA - orderB;
    });

    function applyFilters(list){
        return list.filter(p=>{
            if(q && !p.name.toLowerCase().includes(q)) return false;
            if(roleFilter && roleFilter.length>0 && p.role !== roleFilter) return false;
            return true;
        });
    }

    const aliveFiltered = applyFilters(alive);
    const deadFiltered = applyFilters(dead);

    const all = [...aliveFiltered, ...deadFiltered];

    all.forEach((p)=>{
        const row = document.createElement("div");
        row.className = "player"+(p.alive?"":" dead");

        

        let witchButtons = "";
        if(p.role==="Sorci√®re"){
            witchButtons = `
            <button onclick="useLifePotion('${p.id}')" ${p.lifePotionUsed?"disabled":""}>Potion Vie</button>
            <button onclick="useDeathPotion('${p.id}')" ${p.deathPotionUsed?"disabled":""}>Potion Mort</button>
            `;
        }

        let cupidonButton = "";
        if(p.role === 'Cupidon' && p.alive && !p.cupidonUsed){
            cupidonButton = `<button onclick="startCoupleSelection('${p.id}')">Mettre en couple</button>`;
        }

        let hunterButton = "";
        if(p.role === 'Chasseur' && p.alive){
            hunterButton = `<button onclick="seeChienLoup('${p.id}')">Voir Chien-loup</button>`;
        }

        let angeButton = "";
        if(p.role === 'Ange' && p.alive){
            if(!p.angeRoleChoice){
                angeButton = `<button onclick="startAngeChoice('${p.id}')">Choisir D√©chu/Gardien</button>`;
            } else if(p.angeRoleChoice === 'D√©chu'){
                const t = p.dechuTargetId ? (players.find(x=>x.id==p.dechuTargetId)?.name || 'supprim√©') : 'aucune';
                angeButton = `<span style="margin-right:6px">D√©chu ‚Üí cible: ${t}${p.extraLives?(' (vies:'+p.extraLives+')'):''}</span> <button onclick="startDechuTargetSelection('${p.id}')">Choisir cible</button>`;
            } else if(p.angeRoleChoice === 'Gardien'){
                let protName = 'aucun';
                if(p.angeProtectedId){
                    const protObj = players.find(x=>x.id==p.angeProtectedId);
                    protName = protObj ? protObj.name : 'supprim√©';
                    if(protObj && !protObj.alive) protName += ' (mort)';
                }
                if(!p.angeProtectedId){
                    angeButton = `<button onclick="startAngeGuardianSelection('${p.id}')">Choisir prot√©g√©</button>`;
                } else {
                    angeButton = `<span style="margin-right:6px">Gardien ‚Üí prot√©g√©: ${protName}</span>`;
                }
            }
        }

        let sheriffButton = "";
        if(p.role === 'Sh√©rif' && p.alive){
            sheriffButton = `<button onclick="startSheriffAction('${p.id}')">Emp√™cher action</button>`;
        }

        let instituteurButton = "";
        if(p.role === 'Instituteur' && p.alive){
            instituteurButton = `<button onclick="startInstituteurAction('${p.id}')">Voir loups/solo</button>`;
        }
        let enfantButton = "";
        if(p.role === 'Enfant sauvage' && p.alive){
            if(p.mentorId){
                const mentor = players.find(x=>x.id==p.mentorId);
                const mentorName = mentor ? mentor.name : 'supprim√©';
                enfantButton = `<span style="margin-right:6px">Mentor: ${mentorName}</span> <button onclick="startMentorSelection('${p.id}')">Changer mentor</button>`;
            } else {
                enfantButton = `<button onclick="startMentorSelection('${p.id}')">Choisir mentor</button>`;
            }
        }

        let chienButton = "";
        if(p.role === 'Chien-loup' && p.alive){
            if(p.chienChoice){
                // Afficher le camp choisi sans possibilit√© de le changer
                chienButton = `<span style="margin-right:6px">Camp: ${p.chienChoice}</span>`;
            } else {
                chienButton = `<button onclick="startChienChoice('${p.id}')">Choisir camp</button>`;
            }
        }

        

        let grimeurButton = "";
        if(p.role === 'LG Grimeur' && p.alive){
            const used = p.grimeUsed ? true : false;
            grimeurButton = `<button onclick="startGrime('${p.id}')" ${used?"disabled":""}>Grimer</button>`;
        }

        let infectButton = "";
        if(p.role === 'LG Infect' && p.alive){
            const used = p.infectUsed ? true : false;
            infectButton = `<button onclick="startInfect('${p.id}')" ${used?"disabled":""}>Infecter</button>`;
        }

        let craintifButton = "";
        if(p.role === 'LG Craintif' && p.alive){
            const wolvesCount = players.filter(x=>{
                const camp = (x.role === 'Chien-loup' && x.chienChoice === 'Loup') ? 'LG' : (ROLE_TO_CAMP[x.role] || 'Villageois');
                return x.alive && camp === 'LG';
            }).length;
            if(wolvesCount > 3){
                craintifButton = `<span style="margin-right:8px">R√¥le affich√©: Villageois (fa√ßade tant qu'il y a &gt;3 loups)</span>`;
            } else {
                const used = (p.craintifUsedNight === currentNight);
                craintifButton = `<button onclick="startCraintifAction('${p.id}')" ${used?"disabled":""}>Entrouvrir les yeux (${used?"d√©j√† utilis√©":"1/nuit"})</button>`;
            }
        }

        let vieuxFouButton = "";
        if(p.role === 'Vieux fou' && p.alive && currentNight === 1 && !p.vieuxFouRole){
            vieuxFouButton = `<button onclick="chooseVieuxFouRole('${p.id}')">Choisir r√¥le</button>`;
        }

        let gardeButton = "";
        if(p.role === 'Garde' && p.alive){
            gardeButton = `<button onclick="startGuardProtection('${p.id}')">Prot√©ger</button>`;
        }

        let croqueButton = "";
        if(p.role === 'Croque mort' && p.alive){
            croqueButton = `<button onclick="startCroqueInspect('${p.id}')">Voir tueur d'un mort</button>`;
        }

        let deathInfo = "";
        if(!p.alive && (p.deathKiller || p.deathCause)){
            let parts = [];
            if(p.deathCause) parts.push('Cause: ' + p.deathCause);
            if(p.deathKiller) parts.push('Tueur: ' + p.deathKiller);
            deathInfo = `<div style="font-size:12px;color:#555;margin-top:6px">${parts.join(' ‚Äî ')}</div>`;
        }

        row.innerHTML = `
        <div>
            <b>${p.name}</b> ${p.infected?'<span title="Infect√©">üê∫</span>':''} ${p.grimed?'<span title="Grim√©">üé≠</span>':''} ${p.partnerId?'<span title="En couple">‚ù§Ô∏è</span>':''}
            <div class="actions">
                <button onclick="actionSee('${p.id}')">Voir</button>
                ${witchButtons}
                ${cupidonButton}
                ${hunterButton}
                ${angeButton}
                ${sheriffButton}
                ${instituteurButton}
                ${enfantButton}
                ${chienButton}
                ${vieuxFouButton}
                ${infectButton}
                ${grimeurButton}
                ${gardeButton}
                ${croqueButton}
            </div>
            ${deathInfo}
        </div>
        <div>
            <button class="btn" onclick="toggleAlive('${p.id}')">${p.alive?"Tuer":"R√©animer"}</button>
            <button class="btn" onclick="del('${p.id}')">Supprimer</button>
        </div>
        `;
        div.appendChild(row);
    });

    // Afficher section "Premi√®re nuit" √† partir de la nuit 2
    if(currentNight >= 2){
        const firstNightPlayers = players.filter(p=>p.firstNight && ["Chien-loup","Enfant sauvage","Vieux fou","Cupidon","Chasseur"].includes(p.role));
        if(firstNightPlayers.length > 0){
            const section = document.createElement('div');
            section.style.marginTop = '16px'; section.style.padding = '10px'; section.style.border = '2px solid #ff9800'; section.style.borderRadius = '6px'; section.style.backgroundColor = '#fff3e0';
            const title = document.createElement('div'); title.textContent = '‚≠ê Premi√®re nuit (ont agi la nuit 1)'; title.style.fontWeight = 'bold'; title.style.marginBottom = '8px'; section.appendChild(title);
            firstNightPlayers.forEach(p=>{
                const row = document.createElement('div'); row.style.marginBottom = '4px';
                row.innerHTML = `<b>${p.name}</b> (${p.role})`;
                section.appendChild(row);
            });
            div.appendChild(section);
        }
    }

    // mettre √† jour disponibilit√© des r√¥les dans le select d'ajout
    updateRoleSelectAvailability();
}

// Ajouter joueur
function addPlayer(){
    const nameInput = document.getElementById("name");
    const roleSelect = document.getElementById("roleSelect");
    if(!nameInput.value.trim()) return;

    players.push({
        id: Date.now() + Math.floor(Math.random()*100000),
        name:nameInput.value.trim(),
        role:roleSelect.value,
            chienChoice: undefined,
            angeRoleChoice: undefined,
            dechuTargetId: undefined,
            extraLives: 0,
            angeProtectedId: undefined,
            sheriffTargets: [],
            sheriffBlockedNight: undefined,
        alive:true,
        firstNight:false,
        lifePotionUsed:false,
        deathPotionUsed:false,
        partnerId: undefined,
        cupidonUsed: false,
        vieuxFouRole: undefined,
        vieuxFouResurrected: false,
        croqueUses: 0,
        hiddenNight: undefined,
        deathNight: undefined,
        guardProtectedNight: undefined,
        infectUsed: false,
        grimeUsed: false,
        grimed: false,
        mentorId: undefined,
        wasEnfant: false
            ,craintifUsedNight: undefined
            ,deathKiller: undefined
            ,deathCause: undefined
    });

    nameInput.value="";
    save();
    render();
}

// Actions
function actionSee(id){
    const p = players.find(x => x.id == id);
    if(!p) return;
    // Toujours montrer le r√¥le r√©el ‚Äî y compris pour les joueurs grim√©s ou Enfant sauvage
    const shownRole = p.role;
    alert(p.name + " est " + shownRole);
}
// Chasseur peut voir qui est le Chien-loup
function seeChienLoup(chasseurId){
    const ch = players.find(p=>p.id==chasseurId);
    if(!ch) return;
    const wolves = players.filter(p=>p.role === 'Chien-loup');
    if(wolves.length === 0){ alert('Aucun Chien-loup trouv√©.'); return; }
    const names = wolves.map(w=>w.name + (w.alive ? '' : ' (mort)')).join(', ');
    alert('Chien-loup : ' + names);
}

function startInstituteurAction(instId){
    const inst = players.find(p=>p.id==instId);
    if(!inst) return;
    if(inst.sheriffBlockedNight === currentNight){ alert(inst.name + ' est bloqu√© par le Sh√©rif cette nuit.'); return; }
    if(document.getElementById('institOverlay')) return;
    const overlay = document.createElement('div'); overlay.id='institOverlay';
    overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='320px'; box.style.maxHeight='70%'; box.style.overflow='auto';
    const title = document.createElement('div'); title.textContent = 'Instituteur: voir nombre de loups ou de solos (nuit '+currentNight+')'; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);

    const help = document.createElement('div'); help.style.marginBottom='10px'; help.textContent = 'Choisissez ce que vous voulez voir :'; box.appendChild(help);

    const btnW = document.createElement('button'); btnW.textContent = 'Voir nombre de loups vivants'; btnW.style.marginRight='8px';
    btnW.onclick = ()=>{
        const wolvesCount = players.filter(p=>{
            const camp = (p.role === 'Chien-loup' && p.chienChoice === 'Loup') ? 'LG' : (ROLE_TO_CAMP[p.role] || 'Villageois');
            return p.alive && camp === 'LG';
        }).length;
        alert('Loups vivants: ' + wolvesCount);
        overlay.remove();
    };

    const btnS = document.createElement('button'); btnS.textContent = 'Voir nombre de solos vivants'; btnS.style.marginRight='8px';
    btnS.onclick = ()=>{
        const solosCount = players.filter(p=>{
            const camp = (p.role === 'Chien-loup' && p.chienChoice === 'Loup') ? 'LG' : (ROLE_TO_CAMP[p.role] || 'Villageois');
            return p.alive && camp === 'Solo';
        }).length;
        alert('Solos vivants: ' + solosCount);
        overlay.remove();
    };

    const cancel = document.createElement('button'); cancel.textContent = 'Annuler'; cancel.onclick = ()=>overlay.remove();

    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    actions.appendChild(btnW); actions.appendChild(btnS); actions.appendChild(cancel);
    box.appendChild(actions);
    overlay.appendChild(box); document.body.appendChild(overlay);
}

// --- Loup-garou Craintif: entrouvrir les yeux (1/nuit) ---
function startCraintifAction(cId){
    const p = players.find(x=>x.id==cId);
    if(!p) return;
    if(p.sheriffBlockedNight === currentNight){ alert(p.name + ' est bloqu√© par le Sh√©rif cette nuit.'); return; }
    // calculer loups vivants
    const wolvesCount = players.filter(x=>{
        const camp = (x.role === 'Chien-loup' && x.chienChoice === 'Loup') ? 'LG' : (ROLE_TO_CAMP[x.role] || 'Villageois');
        return x.alive && camp === 'LG';
    }).length;
    if(wolvesCount > 3){
        alert('Trop de loups (>' + 3 + '): vous gardez votre r√¥le de fa√ßade Villageois.');
        return;
    }
}

// Appliquer les cons√©quences lorsqu'un joueur meurt (suppose p.alive === false)
function performDeathEffects(p){
    // demander le pseudo du tueur (overlay) avant d'appliquer les cons√©quences
    if(document.getElementById('deathKillerOverlay')) return;
    const overlay = document.createElement('div'); overlay.id='deathKillerOverlay';
    overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='360px'; box.style.maxHeight='80%'; box.style.overflow='auto';
    const title = document.createElement('div'); title.textContent = 'Qui a tu√© ' + p.name + ' ? (optionnel)'; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);

    const inputRow = document.createElement('div'); inputRow.style.marginBottom='8px';
    inputRow.innerHTML = `<input id="deathKillerInput" placeholder="Pseudo du tueur (laisser vide si inconnu)" style="width:100%; padding:6px">`;
    box.appendChild(inputRow);

    const causeRow = document.createElement('div'); causeRow.style.marginBottom='8px';
    causeRow.innerHTML = `<label style="margin-right:8px"><input type="radio" name="deathCause" value="Loups"> Loups</label><label style="margin-right:8px"><input type="radio" name="deathCause" value="Village"> Village</label><label><input type="radio" name="deathCause" value="Autre"> Autre</label>`;
    box.appendChild(causeRow);

    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Ignorer'; cancel.onclick = ()=>{ overlay.remove(); save(); render(); };
    const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const killer = (document.getElementById('deathKillerInput').value || '').trim();
        const sel = box.querySelector('input[name="deathCause"]:checked');
        const cause = sel ? sel.value : undefined;
        p.deathKiller = killer || undefined;
        p.deathCause = cause;
        // si p vient de mourir, tuer aussi le partenaire
        if(p.partnerId){
            const partner = players.find(x=>x.id == p.partnerId);
            if(partner && partner.alive){
                partner.alive = false;
                alert(partner.name + ' meurt aussi (partenaire de ' + p.name + ')');
            }
        }

        // Si une cible meurt, v√©rifier les Dechus qui l'avaient d√©sign√©e
        players.forEach(ch => {
            if(ch.role === 'Ange' && ch.angeRoleChoice === 'D√©chu' && ch.dechuTargetId == p.id){
                ch.extraLives = (ch.extraLives || 0) + 1;
                ch.dechuTargetId = undefined;
                alert(ch.name + ' (D√©chu) gagne une vie car sa cible ' + p.name + ' est morte.');
            }
        });

        // Si un prot√©g√© meurt, informer le Gardien (le prot√©g√© reste enregistr√© ‚Äî pas de nouveau choix)
        players.forEach(a => {
            if(a.role === 'Ange' && a.angeRoleChoice === 'Gardien' && a.angeProtectedId == p.id){
                alert(a.name + ' (Gardien) perd son prot√©g√© ' + p.name + ' (mort).');
            }
        });

        // Si ce joueur √©tait mentor, convertir les enfants sauvages qui l'avaient choisi
        players.forEach(ch => {
            if(ch.role === 'Enfant sauvage' && ch.mentorId == p.id && ch.alive){
                ch.role = 'LG simple';
                ch.wasEnfant = true;
                alert(ch.name + ' (Enfant sauvage) devient Loup-garou car son mentor ' + p.name + ' est mort.');
            }
        });

        overlay.remove(); save(); render();
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions); overlay.appendChild(box); document.body.appendChild(overlay);
}
function toggleAlive(id){
    const p = players.find(x => x.id == id);
    if(!p) return;
    // si on tente de tuer et que le joueur est prot√©g√© cette nuit, emp√™cher
    if(p.alive && p.guardProtectedNight === currentNight){
        alert(p.name + ' est prot√©g√© par le Garde cette nuit.');
        return;
    }
    // Ange Gardien: immortel tant que son prot√©g√© est vivant
    if(p.alive && p.role === 'Ange' && p.angeRoleChoice === 'Gardien' && p.angeProtectedId){
        const prot = players.find(x=>x.id==p.angeProtectedId);
        if(prot && prot.alive){ alert(p.name + ' est immortel tant que son prot√©g√© est vivant.'); return; }
    }
    // Ange D√©chu: si il a des vies, consommer une vie pour survivre
    if(p.alive && p.role === 'Ange' && p.extraLives && p.extraLives > 0){
        p.extraLives = (p.extraLives||0) - 1;
        save(); render();
        alert(p.name + ' utilise une vie et survit. Vies restantes: ' + p.extraLives);
        return;
    }
    // Vieux fou: choix de cause via overlay (Village / Loups / Autre)
    if(p.alive && p.role === 'Vieux fou' && !p.vieuxFouResurrected && p.vieuxFouRole){
        if(document.getElementById('vieuxDeathOverlay')) return;
        const overlay = document.createElement('div'); overlay.id='vieuxDeathOverlay';
        overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
        overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
        const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='320px'; box.style.maxHeight='70%'; box.style.overflow='auto';
        const title = document.createElement('div'); title.textContent = 'Cause du d√©c√®s pour ' + p.name + ' ?'; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);
        const list = document.createElement('div');
        list.innerHTML = `
            <label><input type="radio" name="vieuxCause" value="Loups"> Loups</label><br>
            <label><input type="radio" name="vieuxCause" value="Village"> Village</label><br>
            <label><input type="radio" name="vieuxCause" value="Autre"> Autre</label>
        `;
        box.appendChild(list);
        const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
        const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>overlay.remove();
        const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
            const sel = box.querySelector('input[name="vieuxCause"]:checked'); if(!sel){ alert('S√©lectionnez une cause.'); return; }
            const choice = sel.value;
            // si correspond au type choisi, ressusciter
            if(choice === 'Loups' && p.vieuxFouRole === 'Ancien'){
                p.vieuxFouResurrected = true; overlay.remove(); save(); render(); alert(p.name + ' (Ancien) ressuscite : tu√© par les loups. (R√©surrection utilis√©e)'); return;
            }
            if(choice === 'Village' && p.vieuxFouRole === 'Cingl√©'){
                p.vieuxFouResurrected = true; overlay.remove(); save(); render(); alert(p.name + ' (Cingl√©) ressuscite : tu√© par le village. (R√©surrection utilis√©e)'); return;
            }
            // sinon on applique la mort
            overlay.remove(); p.alive = false; performDeathEffects(p);
        };
        actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions); overlay.appendChild(box); document.body.appendChild(overlay);
        return;
    }

    p.alive = !p.alive;
    if(p.alive === false) performDeathEffects(p);
}

function del(id){
    // avant suppression, retirer lien de couple si existant
    const p = players.find(x=>x.id==id);
    if(p && p.partnerId){
        const partner = players.find(x=>x.id==p.partnerId);
        if(partner) partner.partnerId = undefined;
    }
    players = players.filter(x => x.id != id);
    save(); render();
}

function toggleFirstNight(id){
    const p = players.find(x => x.id == id);
    p.firstNight = !p.firstNight;
    save();
    render();
}

// Sorci√®re
function useLifePotion(id){
    const p = players.find(x => x.id == id);
    if(!p.lifePotionUsed){ p.lifePotionUsed=true; save(); render(); alert("Potion de vie utiliser"); }
}
function useDeathPotion(id){
    const p = players.find(x => x.id == id);
    if(!p.deathPotionUsed){; p.deathPotionUsed=true; save(); render(); alert("Potion de mort utiliser"); }
}

// --- Vieux fou ---
function chooseVieuxFouRole(vieuxId){
    const v = players.find(p=>p.id==vieuxId); if(!v) return;
    if(document.getElementById('vieuxRoleOverlay')) return;
    const overlay = document.createElement('div'); overlay.id='vieuxRoleOverlay';
    overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='320px';
    const title = document.createElement('div'); title.textContent = 'Vieux fou: choisir Ancien ou Cingl√© (1√®re nuit)'; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);
    const list = document.createElement('div');
    list.innerHTML = `<label><input type="radio" name="vieuxRoleChoice" value="Ancien"> Ancien (ressuscite si tu√© par les Loups)</label><br><label><input type="radio" name="vieuxRoleChoice" value="Cingl√©"> Cingl√© (ressuscite si tu√© par le Village)</label>`;
    box.appendChild(list);
    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>overlay.remove();
    const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const sel = box.querySelector('input[name="vieuxRoleChoice"]:checked'); if(!sel){ alert('S√©lectionnez Ancien ou Cingl√©.'); return; }
        v.vieuxFouRole = sel.value;
        overlay.remove(); save(); render();
        alert(v.name + ' est maintenant '+sel.value+'. Ressuscitera une fois si tu√© par ' + (sel.value==='Ancien'?'les loups':'le village') + '.');
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions); overlay.appendChild(box); document.body.appendChild(overlay);
}

// --- Garde ---
function startGuardProtection(gardeId){
    // Emp√™cher si Garde est bloqu√© par le Sh√©rif cette nuit
    const gardeActor = players.find(p=>p.id==gardeId);
    if(gardeActor && gardeActor.sheriffBlockedNight === currentNight){ alert(gardeActor.name + ' est bloqu√© par le Sh√©rif cette nuit.'); return; }
    if(document.getElementById('gardeOverlay')) return;
    const garde = players.find(p=>p.id==gardeId); if(!garde) return;
    const overlay = document.createElement('div'); overlay.id='gardeOverlay';
    overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='280px'; box.style.maxHeight='70%'; box.style.overflow='auto';
    const title = document.createElement('div'); title.textContent = 'Garde: prot√©ger un joueur (nuit '+currentNight+')'; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);

    const list = document.createElement('div');
    const targetable = players.filter(p=>p.alive && p.id !== gardeId);
    if(targetable.length === 0){ list.textContent = 'Aucun joueur √† prot√©ger.'; }
    targetable.forEach(p=>{
        const row = document.createElement('div'); row.style.marginBottom='6px';
        row.innerHTML = `<label><input type="radio" name="gardeChoice" value="${p.id}"> ${p.name}</label>`;
        list.appendChild(row);
    });
    box.appendChild(list);

    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>overlay.remove();
    const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const sel = box.querySelector('input[name="gardeChoice"]:checked'); if(!sel){ alert('S√©lectionnez un joueur.'); return; }
        const targetId = sel.value;
        protectTarget(gardeId, targetId);
        overlay.remove();
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions);
    overlay.appendChild(box); document.body.appendChild(overlay);
}

function protectTarget(gardeId, targetId){
    const target = players.find(p=>p.id==targetId);
    if(!target) return;
    target.guardProtectedNight = currentNight;
    save(); render();
    alert(target.name + ' est prot√©g√© par le Garde pour la nuit ' + currentNight + '.');
}

// --- Infect (p√®re des loups infect) ---
function startInfect(infectId){
    // Emp√™cher si Infect est bloqu√© par le Sh√©rif cette nuit
    const infectActor = players.find(p=>p.id==infectId);
    if(infectActor && infectActor.sheriffBlockedNight === currentNight){ alert(infectActor.name + ' est bloqu√© par le Sh√©rif cette nuit.'); return; }
    if(document.getElementById('infectOverlay')) return;
    const infect = players.find(p=>p.id==infectId); if(!infect) return;
    if(infect.infectUsed){ alert(infect.name + ' a d√©j√† utilis√© son pouvoir d\'infection.'); return; }
    const overlay = document.createElement('div'); overlay.id='infectOverlay';
    overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='280px'; box.style.maxHeight='70%'; box.style.overflow='auto';
    const title = document.createElement('div'); title.textContent = 'Infecter: choisir une cible (nuit '+currentNight+')'; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);

    const list = document.createElement('div');
    // cibles possibles: vivants, pas soi-m√™me
    const targetable = players.filter(p=>p.alive && p.id !== infectId);
    if(targetable.length === 0){ list.textContent = 'Aucune cible disponible.'; }
    targetable.forEach(p=>{
        const row = document.createElement('div'); row.style.marginBottom='6px';
        row.innerHTML = `<label><input type="radio" name="infectChoice" value="${p.id}"> ${p.name}</label>`;
        list.appendChild(row);
    });
    box.appendChild(list);

    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>overlay.remove();
    const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const sel = box.querySelector('input[name="infectChoice"]:checked'); if(!sel){ alert('S√©lectionnez un joueur.'); return; }
        const targetId = sel.value;
        performInfect(infectId, targetId);
        overlay.remove();
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions);
    overlay.appendChild(box); document.body.appendChild(overlay);
}

function performInfect(infectId, targetId){
    const inf = players.find(p=>p.id==infectId); if(!inf) return;
    const target = players.find(p=>p.id==targetId); if(!target) return;
    // marquer l'infection: on conserve ancien r√¥le et on note l'infection
    target.infected = true;
    target.infectedBy = infectId;
    target.infectedNight = currentNight;
    // marquer que l'infecteur a utilis√© son pouvoir (une seule fois)
    inf.infectUsed = true;
    // Optionnel: changer de camp/role automatiquement ‚Äî ici on ne modifie pas le r√¥le principal
    save(); render();
    alert(target.name + ' a √©t√© infect√© (nuit '+currentNight+').');
}

// --- Grimeur ---
function startGrime(grimeurId){
    // Emp√™cher si Grimeur est bloqu√© par le Sh√©rif cette nuit
    const grActor = players.find(p=>p.id==grimeurId);
    if(grActor && grActor.sheriffBlockedNight === currentNight){ alert(grActor.name + ' est bloqu√© par le Sh√©rif cette nuit.'); return; }
    if(document.getElementById('grimeOverlay')) return;
    const gr = players.find(p=>p.id==grimeurId); if(!gr) return;
    if(gr.grimeUsed){ alert(gr.name + ' a d√©j√† utilis√© son pouvoir de grimer.'); return; }
    const overlay = document.createElement('div'); overlay.id='grimeOverlay';
    overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='280px'; box.style.maxHeight='70%'; box.style.overflow='auto';
    const title = document.createElement('div'); title.textContent = 'Grimer: choisir une cible (nuit '+currentNight+')'; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);

    const list = document.createElement('div');
    // Seules les victimes mortes peuvent √™tre grim√©es
    const targetable = players.filter(p=>!p.alive && p.id !== grimeurId);
    if(targetable.length === 0){ list.textContent = 'Aucune cible disponible.'; }
    targetable.forEach(p=>{
        const row = document.createElement('div'); row.style.marginBottom='6px';
        row.innerHTML = `<label><input type="radio" name="grimeChoice" value="${p.id}"> ${p.name}</label>`;
        list.appendChild(row);
    });
    box.appendChild(list);

    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>overlay.remove();
    const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const sel = box.querySelector('input[name="grimeChoice"]:checked'); if(!sel){ alert('S√©lectionnez un joueur.'); return; }
        const targetId = sel.value;
        performGrime(grimeurId, targetId);
        overlay.remove();
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions);
    overlay.appendChild(box); document.body.appendChild(overlay);
}

function performGrime(grimeurId, targetId){
    const gr = players.find(p=>p.id==grimeurId); if(!gr) return;
    const target = players.find(p=>p.id==targetId); if(!target) return;
    target.grimed = true;
    target.grimedBy = grimeurId;
    target.grimedNight = currentNight;
    gr.grimeUsed = true;
    save(); render();
    alert(target.name + ' a √©t√© grim√© (sera vu comme Loup-garou simple).');
}

// --- Enfant sauvage: choisir un mentor ---
function startMentorSelection(childId){
    if(document.getElementById('mentorOverlay')) return;
    const child = players.find(p=>p.id==childId); if(!child) return;
    const overlay = document.createElement('div'); overlay.id='mentorOverlay';
    overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='280px'; box.style.maxHeight='70%'; box.style.overflow='auto';
    const title = document.createElement('div'); title.textContent = 'Choisir un mentor pour ' + child.name; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);

    const list = document.createElement('div');
    // mentors possibles: vivants et pas l'enfant lui-m√™me
    const targetable = players.filter(p=>p.alive && p.id !== childId);
    if(targetable.length === 0){ list.textContent = 'Aucun mentor disponible.'; }
    targetable.forEach(p=>{
        const row = document.createElement('div'); row.style.marginBottom='6px';
        row.innerHTML = `<label><input type="radio" name="mentorChoice" value="${p.id}"> ${p.name}</label>`;
        list.appendChild(row);
    });
    box.appendChild(list);

    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>overlay.remove();
    const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const sel = box.querySelector('input[name="mentorChoice"]:checked'); if(!sel){ alert('S√©lectionnez un mentor.'); return; }
        const mentorId = sel.value;
        setMentor(childId, mentorId);
        overlay.remove();
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions);
    overlay.appendChild(box); document.body.appendChild(overlay);
}

function setMentor(childId, mentorId){
    const child = players.find(p=>p.id==childId); if(!child) return;
    const mentor = players.find(p=>p.id==mentorId);
    if(!mentor){ alert('Mentor introuvable'); return; }
    child.mentorId = mentorId;
    save(); render();
    alert(child.name + ' a choisi ' + mentor.name + ' comme mentor.');
}

 
// --- Ange: choix et actions (D√©chu / Gardien) ---
function startAngeChoice(angeId){
    if(document.getElementById('angeChoiceOverlay')) return;
    const ange = players.find(p=>p.id==angeId); if(!ange) return;
    const overlay = document.createElement('div'); overlay.id='angeChoiceOverlay';
    overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='280px'; box.style.maxHeight='70%'; box.style.overflow='auto';
    const title = document.createElement('div'); title.textContent = 'Ange: choisir D√©chu ou Gardien'; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);
    const list = document.createElement('div');
    list.innerHTML = `<label><input type="radio" name="angeChoice" value="D√©chu"> D√©chu</label><br><label><input type="radio" name="angeChoice" value="Gardien"> Gardien</label>`;
    box.appendChild(list);
    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>overlay.remove();
    const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const sel = box.querySelector('input[name="angeChoice"]:checked'); if(!sel){ alert('S√©lectionnez D√©chu ou Gardien.'); return; }
        ange.angeRoleChoice = sel.value;
        save(); render();
        // si D√©chu, inviter √† choisir une cible maintenant
        if(sel.value === 'D√©chu') startDechuTargetSelection(angeId);
        // si Gardien, autoriser s√©lection seulement si premi√®re nuit
        if(sel.value === 'Gardien'){
            startAngeGuardianSelection(angeId);
        }
        overlay.remove();
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions);
    overlay.appendChild(box); document.body.appendChild(overlay);
}

function startDechuTargetSelection(angeId){
    // Emp√™cher si Ange (acteur) est bloqu√© par le Sh√©rif cette nuit
    const angeActor = players.find(p=>p.id==angeId);
    if(angeActor && angeActor.sheriffBlockedNight === currentNight){ alert(angeActor.name + ' est bloqu√© par le Sh√©rif cette nuit.'); return; }
    if(document.getElementById('dechuOverlay')) return;
    const ange = players.find(p=>p.id==angeId); if(!ange) return;
    const overlay = document.createElement('div'); overlay.id='dechuOverlay';
    overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='280px'; box.style.maxHeight='70%'; box.style.overflow='auto';
    const title = document.createElement('div'); title.textContent = 'D√©chu: choisir une cible'; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);
    const list = document.createElement('div');
    const targetable = players.filter(p=>p.alive && p.id !== angeId);
    if(targetable.length === 0) list.textContent = 'Aucune cible disponible.';
    targetable.forEach(t=>{ const row = document.createElement('div'); row.style.marginBottom='6px'; row.innerHTML = `<label><input type="radio" name="dechuChoice" value="${t.id}"> ${t.name} ${t.alive? '': '(mort)'} </label>`; list.appendChild(row); });
    box.appendChild(list);
    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>overlay.remove();
    const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const sel = box.querySelector('input[name="dechuChoice"]:checked'); if(!sel){ alert('S√©lectionnez une cible.'); return; }
        setDechuTarget(angeId, sel.value);
        overlay.remove();
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions);
    overlay.appendChild(box); document.body.appendChild(overlay);
}

function setDechuTarget(angeId, targetId){
    const a = players.find(p=>p.id==angeId); if(!a) return;
    a.dechuTargetId = targetId;
    save(); render();
    const t = players.find(p=>p.id==targetId);
    alert(a.name + ' (D√©chu) d√©signe ' + (t? t.name : 'inconnu') + ' comme cible.');
}

function startAngeGuardianSelection(angeId){
    if(document.getElementById('angeGuardianOverlay')) return;
    const ange = players.find(p=>p.id==angeId); if(!ange) return;
    if(ange.angeProtectedId){ alert(ange.name + ' a d√©j√† choisi un prot√©g√©.'); return; }
    const overlay = document.createElement('div'); overlay.id='angeGuardianOverlay';
    overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='280px'; box.style.maxHeight='70%'; box.style.overflow='auto';
    const title = document.createElement('div'); title.textContent = 'Gardien: choisir votre prot√©g√© (1√®re nuit)'; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);
    const list = document.createElement('div');
    const targetable = players.filter(p=>p.alive && p.id !== angeId);
    if(targetable.length === 0) list.textContent = 'Aucun joueur vivant disponible.';
    targetable.forEach(t=>{ const row = document.createElement('div'); row.style.marginBottom='6px'; row.innerHTML = `<label><input type="radio" name="guardianChoice" value="${t.id}"> ${t.name}</label>`; list.appendChild(row); });
    box.appendChild(list);
    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>overlay.remove();
    const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const sel = box.querySelector('input[name="guardianChoice"]:checked'); if(!sel){ alert('S√©lectionnez un joueur.'); return; }
        setAngeProtected(angeId, sel.value);
        overlay.remove();
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions);
    overlay.appendChild(box); document.body.appendChild(overlay);
}

// --- Croque-mort: voir qui a tu√© une victime morte ---
function startCroqueInspect(croqueId){
    const actor = players.find(p=>p.id==croqueId);
    if(!actor) return;
    if(actor.sheriffBlockedNight === currentNight){ alert(actor.name + ' est bloqu√© par le Sh√©rif cette nuit.'); return; }
    if(document.getElementById('croqueOverlay')) return;
    const overlay = document.createElement('div'); overlay.id='croqueOverlay';
    overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='320px'; box.style.maxHeight='70%'; box.style.overflow='auto';
    const title = document.createElement('div'); title.textContent = 'Croque-mort: choisir une victime morte √† inspecter'; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);

    const list = document.createElement('div');
    const deadList = players.filter(p=>!p.alive);
    if(deadList.length === 0) list.textContent = 'Aucun joueur mort √† inspecter.';
    deadList.forEach(d=>{ const row = document.createElement('div'); row.style.marginBottom='6px'; row.innerHTML = `<label><input type="radio" name="croqueChoice" value="${d.id}"> ${d.name} ${d.deathCause?('('+d.deathCause+')'):''}</label>`; list.appendChild(row); });
    box.appendChild(list);

    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>overlay.remove();
    const ok = document.createElement('button'); ok.textContent='Voir tueur'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const sel = box.querySelector('input[name="croqueChoice"]:checked'); if(!sel){ alert('S√©lectionnez une victime.'); return; }
        const target = players.find(p=>p.id==sel.value);
        if(!target){ alert('Victime introuvable.'); return; }
        const killer = target.deathKiller || 'inconnu';
        alert(target.name + (target.deathKiller?('\nTueur: ' + killer):''));
        overlay.remove();
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions); overlay.appendChild(box); document.body.appendChild(overlay);
}

function setAngeProtected(angeId, targetId){
    const a = players.find(p=>p.id==angeId); if(!a) return;
    a.angeProtectedId = targetId;
    save(); render();
    const t = players.find(p=>p.id==targetId);
    alert(a.name + ' (Gardien) prot√®ge ' + (t? t.name : 'inconnu') + ' tant qu\'il est vivant.');
}
// --- Sh√©rif: emp√™cher l'action d'un joueur ---
function startSheriffAction(sheriffId){
    if(document.getElementById('sherifOverlay')) return;
    const sheriff = players.find(p=>p.id==sheriffId); if(!sheriff) return;
    if(currentNight === 1){ alert('Le Sh√©rif ne peut pas agir la premi√®re nuit.'); return; }
    const overlay = document.createElement('div'); overlay.id='sherifOverlay';
    overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='320px'; box.style.maxHeight='70%'; box.style.overflow='auto';
    const title = document.createElement('div'); title.textContent = 'Sh√©rif: emp√™cher l\'action d\'un joueur (nuit '+currentNight+')'; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);
    const list = document.createElement('div');
    // cibles: vivants, pas soi-m√™me, et pas d√©j√† vis√©s par ce sh√©rif
    const targetable = players.filter(p=>p.alive && p.id !== sheriffId && !(sheriff.sheriffTargets || []).includes(p.id));
    if(targetable.length === 0){ list.textContent = 'Aucune cible disponible (ou d√©j√† vis√©e auparavant).'; }
    targetable.forEach(p=>{ const row = document.createElement('div'); row.style.marginBottom='6px'; row.innerHTML = `<label><input type="radio" name="sherifChoice" value="${p.id}"> ${p.name}</label>`; list.appendChild(row); });
    box.appendChild(list);
    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>overlay.remove();
    const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const sel = box.querySelector('input[name="sherifChoice"]:checked'); if(!sel){ alert('S√©lectionnez un joueur.'); return; }
        performSheriff(sheriffId, sel.value);
        overlay.remove();
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions);
    overlay.appendChild(box); document.body.appendChild(overlay);
}

function performSheriff(sheriffId, targetId){
    const s = players.find(p=>p.id==sheriffId); if(!s) return;
    const t = players.find(p=>p.id==targetId); if(!t) return;
    t.sheriffBlockedNight = currentNight;
    s.sheriffTargets = s.sheriffTargets || [];
    s.sheriffTargets.push(targetId);
    save(); render();
    alert(s.name + ' (Sh√©rif) emp√™che l\'action de ' + t.name + ' pour la nuit ' + currentNight + '.');
}
// --- Chien-loup: choix de camp ---
function startChienChoice(chienId){
    if(document.getElementById('chienOverlay')) return;
    const ch = players.find(p=>p.id==chienId); if(!ch) return;
    if(ch.chienChoice){ alert(ch.name + ' a d√©j√† choisi son camp: ' + ch.chienChoice + '. Impossible de changer.'); return; }
    const overlay = document.createElement('div'); overlay.id='chienOverlay';
    overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='280px'; box.style.maxHeight='70%'; box.style.overflow='auto';
    const title = document.createElement('div'); title.textContent = 'Chien-loup: choisir le camp'; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);
    const list = document.createElement('div');
    const optionL = document.createElement('div'); optionL.innerHTML = `<label><input type="radio" name="chienChoice" value="Loup" ${ch.chienChoice==='Loup'?'checked':''}> Loup (joue comme loup)</label>`;
    const optionC = document.createElement('div'); optionC.innerHTML = `<label><input type="radio" name="chienChoice" value="Chien" ${ch.chienChoice==='Chien'?'checked':''}> Chien (joue comme villageois)</label>`;
    list.appendChild(optionL); list.appendChild(optionC); box.appendChild(list);
    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>overlay.remove();
    const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const sel = box.querySelector('input[name="chienChoice"]:checked'); if(!sel){ alert('S√©lectionnez un camp.'); return; }
        setChienChoice(chienId, sel.value);
        overlay.remove();
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions);
    overlay.appendChild(box); document.body.appendChild(overlay);
}

function setChienChoice(chienId, choice){
    const p = players.find(x=>x.id==chienId); if(!p) return;
    p.chienChoice = choice;
    save(); render();
    alert(p.name + ' choisit le camp: ' + choice + '.');
}

// Helper: r√¥le affich√© √† la Voyante (√† utiliser si la Voyante est r√©introduite)
function getRoleForVoyante(p){
    if(!p) return undefined;
    // Loup-garou craintif: fa√ßade Villageois tant qu'il y a plus de 3 loups vivants
    if(p.role === 'LG Craintif'){
        const wolvesCount = players.filter(x=>{
            const camp = (x.role === 'Chien-loup' && x.chienChoice === 'Loup') ? 'LG' : (ROLE_TO_CAMP[x.role] || 'Villageois');
            return x.alive && camp === 'LG';
        }).length;
        if(wolvesCount > 3) return 'Villageois';
    }
    if(p.role === 'Chien-loup' && p.chienChoice === 'Loup') return 'Villageois';
    return p.role;
}
</script>
</body>
</html>

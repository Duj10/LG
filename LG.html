<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Gestion LG</title>
<style>
body { font-family: Arial; margin: 20px; }
h2 { margin-top: 25px; }
.player {
    margin: 6px 0; padding: 10px; border-radius: 6px;
    border: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center;
}
.dead { opacity: 0.45; }
.btn { padding: 4px 8px; margin-left: 5px; }
.actions button { margin-right: 5px; }
</style>
</head>
<body>

<h2>Ajouter un joueur</h2>
<input id="name" placeholder="Nom">
<select id="roleSelect">
    <!--Villageois-->
    <option value="Villageois">Villageois</option>
    <option value="Sorcière">Sorcière</option>
    <option value="Renard">Renard</option>
    <option value="Vieux fou">Vieux fou</option>
    <option value="Chasseur">Chasseur</option>
    <option value="Cupidon">Cupidon</option>
    <option value="Voyante">Voyante</option>
    <option value="Garde">Garde</option>
    <option value="Croque mort">Croque mort</option>

    <!--LG-->
    <option value="LG simple">Loup-garou simple</option>
    <option value="LG Infect">Infect père des loups</option>
    <option value="LG Grimeur">Loup-garou grimeur</option>
    <option value="LG Noir">Loup-garou noir</option>
    <option value="LG Blanc">Loup-garou blanc</option>

    <!--Solo-->
    <option value="Ange">Ange</option>
    <option value="Cannibale">Cannibale</option>
    <option value="Assassin">Assassin</option>

    <!--Bipolaire-->
    <option value="Chien-loup">Chien-loup</option>
    <option value="Enfant sauvage">Enfant sauvage</option>

</select>
<button onclick="addPlayer()">Ajouter</button>

<h2>Joueurs</h2>
<div style="margin-bottom:10px">
    <input id="search" placeholder="Recherche par nom..." style="margin-right:6px">
    <select id="roleFilter">
        <option value="">Tous rôles</option>
    </select>
    <button onclick="exportPlayers()" style="margin-left:8px">Exporter JSON</button>
    <button onclick="document.getElementById('importFile').click()">Importer JSON</button>
    <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importPlayers(event)">
</div>
<div id="list"></div>

<script>
const ROLE_ORDER = [
    "Ange","Chien-loup","Enfant sauvage","Vieux fou","Cupidon","Chasseur",
    "Voyante","Garde","Croque mort","Cannibale","Renard",
    "LG simple","LG Infect","LG Grimeur","LG Noir","LG Blanc","Sorcière","Assassin","Villageois"
];

// Camps et mapping rôle -> camp
const CAMP_ORDER = ["Villageois","LG","Solo","Bipolaire"];
const ROLE_TO_CAMP = {
    "Villageois":"Villageois",
    "Sorcière":"Villageois",
    "Renard":"Villageois",
    "Vieux fou":"Villageois",
    "Chasseur":"Villageois",
    "Cupidon":"Villageois",
    "Voyante":"Villageois",
    "Garde":"Villageois",
    "Croque mort":"Villageois",

    "LG simple":"LG",
    "LG Infect":"LG",
    "LG Grimeur":"LG",
    "LG Noir":"LG",
    "LG Blanc":"LG",

    "Ange":"Solo",
    "Cannibale":"Solo",
    "Assassin":"Solo",

    "Chien-loup":"Bipolaire",
    "Enfant sauvage":"Bipolaire"
};

// Charger/sauvegarder joueurs
let players = JSON.parse(localStorage.getItem("lg_players") || "[]");

// Remplir filtre de rôle
function populateRoleFilter(){
    const sel = document.getElementById('roleFilter');
    // populate with camps (Villageois, LG, Solo, Bipolaire)
    CAMP_ORDER.forEach(c=>{
        const opt = document.createElement('option'); opt.value = c; opt.textContent = c; sel.appendChild(opt);
    });
}

// Export / Import JSON
function exportPlayers(){
    const data = JSON.stringify(players, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'lg_players.json'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
}

function importPlayers(ev){
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
        try{
            const data = JSON.parse(reader.result);
            if(!Array.isArray(data)) throw new Error('Format invalide');
            // validation basique des entrées
            const validated = data.map((p, idx)=>{
                if(!p || typeof p !== 'object') throw new Error('Entrée '+(idx+1)+' invalide');
                if(!p.name || typeof p.name !== 'string') throw new Error('Entrée '+(idx+1)+' manque un nom valide');
                return {
                    name: p.name,
                    role: (p.role && typeof p.role === 'string') ? p.role : 'Villageois',
                    alive: typeof p.alive === 'boolean' ? p.alive : true,
                    firstNight: !!p.firstNight,
                    lifePotionUsed: !!p.lifePotionUsed,
                    deathPotionUsed: !!p.deathPotionUsed,
                    id: p.id || undefined
                };
            });

            if(players.length > 0){
                const replace = confirm('Il y a déjà des joueurs enregistrés. OK = remplacer, Annuler = fusionner (ajouter)');
                if(replace){
                    players = validated;
                } else {
                    // fusion: ajouter en évitant doublons d'ID
                    const existingIds = new Set(players.map(p=>p.id));
                    validated.forEach(p=>{
                        if(!p.id || existingIds.has(p.id)) p.id = Date.now() + Math.floor(Math.random()*100000);
                        players.push(p);
                    });
                }
            } else {
                players = validated;
            }

            save(); render(); alert('Import réussi');
        }catch(e){ alert('Import échoué: '+e.message); }
    };
    reader.readAsText(file);
    // reset input
    ev.target.value = '';
}

// initialisation: remplir filtre, lier événements et rendre
populateRoleFilter();
document.getElementById('search').addEventListener('input', render);
document.getElementById('roleFilter').addEventListener('change', render);
render();

// Mettre à jour la disponibilité des options dans le select d'ajout
function updateRoleSelectAvailability(){
    const sel = document.getElementById('roleSelect');
    if(!sel) return;
    const used = new Set(players.map(p=>p.role));
    Array.from(sel.options).forEach(opt=>{
        // Autoriser plusieurs 'Villageois' : ne pas désactiver cette option
        if(opt.value === 'Villageois') { opt.disabled = false; return; }
        // Désactiver les rôles déjà utilisés (sauf Villageois)
        if(opt.value && used.has(opt.value)) opt.disabled = true; else opt.disabled = false;
    });
}

function save() {
    localStorage.setItem("lg_players", JSON.stringify(players));
}

// Assurer que chaque joueur a un ID unique
function ensurePlayerIds() {
    players.forEach((p, i) => {
        if (!p.id) p.id = Date.now() + i;
    });
}

// Trier selon l'ordre et la case Première nuit
function render() {
    ensurePlayerIds();
    const div = document.getElementById("list");
    div.innerHTML = "";

    // Appliquer filtres
    const q = document.getElementById('search') ? document.getElementById('search').value.trim().toLowerCase() : '';
    const roleFilter = document.getElementById('roleFilter') ? document.getElementById('roleFilter').value : '';

    // Séparer morts et vivants
    const alive = players.filter(p => p.alive);
    const dead = players.filter(p => !p.alive);

    // Trier vivants selon ROLE_ORDER
    alive.sort((a,b)=>{
        const campA = ROLE_TO_CAMP[a.role] || 'Villageois';
        const campB = ROLE_TO_CAMP[b.role] || 'Villageois';
        const orderCampA = CAMP_ORDER.indexOf(campA);
        const orderCampB = CAMP_ORDER.indexOf(campB);
        if(orderCampA !== orderCampB) return orderCampA - orderCampB;
        // même camp -> fallback sur ROLE_ORDER
        const orderA = ROLE_ORDER.indexOf(a.role);
        const orderB = ROLE_ORDER.indexOf(b.role);
        if(a.firstNight && !b.firstNight) return 1;
        if(!a.firstNight && b.firstNight) return -1;
        return orderA - orderB;
    });

    function applyFilters(list){
        return list.filter(p=>{
            if(q && !p.name.toLowerCase().includes(q)) return false;
            if(roleFilter && roleFilter.length>0 && p.role !== roleFilter) return false;
            return true;
        });
    }

    const aliveFiltered = applyFilters(alive);
    const deadFiltered = applyFilters(dead);

    const all = [...aliveFiltered, ...deadFiltered];

    all.forEach((p)=>{
        const row = document.createElement("div");
        row.className = "player"+(p.alive?"":" dead");

        let firstNightCheckbox = "";
        if(["Chien-loup","Enfant sauvage","Vieux fou","Cupidon","Chasseur"].includes(p.role) && p.alive){
            firstNightCheckbox = `<label><input type="checkbox" onchange="toggleFirstNight('${p.id}')" ${p.firstNight?'checked':''}> Première nuit</label>`;
        }

        let witchButtons = "";
        if(p.role==="Sorcière"){
            witchButtons = `
            <button onclick="useLifePotion('${p.id}')" ${p.lifePotionUsed?"disabled":""}>Potion Vie</button>
            <button onclick="useDeathPotion('${p.id}')" ${p.deathPotionUsed?"disabled":""}>Potion Mort</button>
            `;
        }

        row.innerHTML = `
        <div>
            <b>${p.name}</b>
            <div class="actions">
                <button onclick="actionSee('${p.id}')">Voir</button>
                ${firstNightCheckbox}
                ${witchButtons}
            </div>
        </div>
        <div>
            <button class="btn" onclick="toggleAlive('${p.id}')">${p.alive?"Tuer":"Réanimer"}</button>
            <button class="btn" onclick="del('${p.id}')">Supprimer</button>
        </div>
        `;
        div.appendChild(row);
    });

    // mettre à jour disponibilité des rôles dans le select d'ajout
    updateRoleSelectAvailability();
}

// Ajouter joueur
function addPlayer(){
    const nameInput = document.getElementById("name");
    const roleSelect = document.getElementById("roleSelect");
    if(!nameInput.value.trim()) return;

    players.push({
        name:nameInput.value.trim(),
        role:roleSelect.value,
        alive:true,
        firstNight:false,
        lifePotionUsed:false,
        deathPotionUsed:false
    });

    nameInput.value="";
    save();
    render();
}

// Actions
function actionSee(id){ const p = players.find(x => x.id == id); alert(p.name+" est "+p.role); }
function toggleAlive(id){ const p = players.find(x => x.id == id); p.alive=!p.alive; save(); render(); }
function del(id){ players = players.filter(x => x.id != id); save(); render(); }

function toggleFirstNight(id){
    const p = players.find(x => x.id == id);
    p.firstNight = !p.firstNight;
    save();
    render();
}

// Sorcière
function useLifePotion(id){
    const p = players.find(x => x.id == id);
    if(!p.lifePotionUsed){ p.lifePotionUsed=true; save(); render(); alert("Potion de vie utiliser"); }
}
function useDeathPotion(id){
    const p = players.find(x => x.id == id);
    if(!p.deathPotionUsed){; p.deathPotionUsed=true; save(); render(); alert("Potion de mort utiliser"); }
}
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Gestion LG</title>
<style>
body { font-family: Arial; margin: 20px; }
h2 { margin-top: 25px; }
.player {
    margin: 6px 0; padding: 10px; border-radius: 6px;
    border: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center;
}
.dead { opacity: 0.45; }
.btn { padding: 4px 8px; margin-left: 5px; }
.actions button { margin-right: 5px; }
</style>
</head>
<body>

<h2>Ajouter un joueur</h2>
<input id="name" placeholder="Nom">
<select id="roleSelect">
    <!--Villageois-->
    <option value="Villageois">Villageois</option>
    <option value="Sorcière">Sorcière</option>
    <option value="Renard">Renard</option>
    <option value="Vieux fou">Vieux fou</option>
    <option value="Chasseur">Chasseur</option>
    <option value="Cupidon">Cupidon</option>
    <option value="Voyante">Voyante</option>
    <option value="Garde">Garde</option>
    <option value="Croque mort">Croque mort</option>
    <option value="Instituteur" disabled>L'instituteur</option>

    <!--LG-->
    <option value="LG simple">Loup-garou simple</option>
    <option value="LG Infect">Infect père des loups</option>
    <option value="LG Grimeur">Loup-garou grimeur</option>
    <option value="LG Noir">Loup-garou noir</option>
    <option value="LG Blanc">Loup-garou blanc</option>

    <!--Solo-->
    <option value="Ange">Ange</option>
    <option value="Cannibale">Cannibale</option>
    <option value="Assassin">Assassin</option>

    <!--Bipolaire-->
    <option value="Chien-loup">Chien-loup</option>
    <option value="Enfant sauvage">Enfant sauvage</option>

</select>
<button onclick="addPlayer()">Ajouter</button>

<h2>Joueurs</h2>
<div style="margin-bottom:10px">
    <input id="search" placeholder="Recherche par nom..." style="margin-right:6px">
    <select id="roleFilter">
        <option value="">Tous rôles</option>
    </select>
    <span style="margin-left:12px">Nuit: <span id="nightDisplay">1</span></span>
    <button onclick="nextNight()" style="margin-left:6px">Nouvelle nuit</button>
    <button onclick="resetNight()" style="margin-left:6px">Réinitialiser nuit</button>
    <button onclick="exportPlayers()" style="margin-left:8px">Exporter JSON</button>
    <button onclick="document.getElementById('importFile').click()">Importer JSON</button>
    <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importPlayers(event)">
</div>
<div id="list"></div>

<script>
const ROLE_ORDER = [
    "Ange","Chien-loup","Enfant sauvage","Vieux fou","Cupidon","Chasseur",
    "Voyante","Garde","Croque mort","Cannibale","Renard",
    "LG simple","LG Infect","LG Grimeur","LG Noir","LG Blanc","Sorcière","Assassin","Villageois"
];

// Camps et mapping rôle -> camp
const CAMP_ORDER = ["Villageois","LG","Solo","Bipolaire"];
const ROLE_TO_CAMP = {
    "Villageois":"Villageois",
    "Sorcière":"Villageois",
    "Renard":"Villageois",
    "Vieux fou":"Villageois",
    "Chasseur":"Villageois",
    "Cupidon":"Villageois",
    "Voyante":"Villageois",
    "Garde":"Villageois",
    "Croque mort":"Villageois",
    "Instituteur":"Villageois",

    "LG simple":"LG",
    "LG Infect":"LG",
    "LG Grimeur":"LG",
    "LG Noir":"LG",
    "LG Blanc":"LG",

    "Ange":"Solo",
    "Cannibale":"Solo",
    "Assassin":"Solo",

    "Chien-loup":"Bipolaire",
    "Enfant sauvage":"Bipolaire"
};

// Charger/sauvegarder joueurs
let players = JSON.parse(localStorage.getItem("lg_players") || "[]");

// nuit courante (persistée séparément)
let currentNight = parseInt(localStorage.getItem("lg_currentNight") || "1", 10);
function saveNight(){ localStorage.setItem("lg_currentNight", String(currentNight)); }

// Remplir filtre de rôle
function populateRoleFilter(){
    const sel = document.getElementById('roleFilter');
    // populate with camps (Villageois, LG, Solo, Bipolaire)
    CAMP_ORDER.forEach(c=>{
        const opt = document.createElement('option'); opt.value = c; opt.textContent = c; sel.appendChild(opt);
    });
}

// Export / Import JSON
function exportPlayers(){
    const data = JSON.stringify(players, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'lg_players.json'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
}

function importPlayers(ev){
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
        try{
            const data = JSON.parse(reader.result);
            if(!Array.isArray(data)) throw new Error('Format invalide');
            // validation basique des entrées
            const validated = data.map((p, idx)=>{
                if(!p || typeof p !== 'object') throw new Error('Entrée '+(idx+1)+' invalide');
                if(!p.name || typeof p.name !== 'string') throw new Error('Entrée '+(idx+1)+' manque un nom valide');
                return {
                    name: p.name,
                    role: (p.role && typeof p.role === 'string') ? p.role : 'Villageois',
                    alive: typeof p.alive === 'boolean' ? p.alive : true,
                    firstNight: !!p.firstNight,
                    lifePotionUsed: !!p.lifePotionUsed,
                    deathPotionUsed: !!p.deathPotionUsed,
                    id: p.id || undefined,
                    partnerId: p.partnerId || undefined,
                    cupidonUsed: !!p.cupidonUsed,
                    croqueUses: typeof p.croqueUses === 'number' ? p.croqueUses : 0,
                    hiddenNight: typeof p.hiddenNight === 'number' ? p.hiddenNight : undefined,
                    deathNight: typeof p.deathNight === 'number' ? p.deathNight : undefined,
                    vieuxFouRole: p.vieuxFouRole || undefined,
                    vieuxFouResurrected: !!p.vieuxFouResurrected,
                    guardProtectedNight: typeof p.guardProtectedNight === 'number' ? p.guardProtectedNight : undefined
                };
            });

            if(players.length > 0){
                const replace = confirm('Il y a déjà des joueurs enregistrés. OK = remplacer, Annuler = fusionner (ajouter)');
                if(replace){
                    players = validated;
                } else {
                    // fusion: ajouter en évitant doublons d'ID
                    const existingIds = new Set(players.map(p=>p.id));
                    validated.forEach(p=>{
                        if(!p.id || existingIds.has(p.id)) p.id = Date.now() + Math.floor(Math.random()*100000);
                        players.push(p);
                    });
                }
            } else {
                players = validated;
            }

            save(); render(); alert('Import réussi');
        }catch(e){ alert('Import échoué: '+e.message); }
    };
    reader.readAsText(file);
    // reset input
    ev.target.value = '';
}

// initialisation: remplir filtre, lier événements et rendre
populateRoleFilter();
    document.getElementById('search').addEventListener('input', render);
    document.getElementById('roleFilter').addEventListener('change', render);
    render();
    // afficher la nuit courante au chargement
    updateNightDisplay();

// Mettre à jour la disponibilité des options dans le select d'ajout
function updateRoleSelectAvailability(){
    const sel = document.getElementById('roleSelect');
    if(!sel) return;
    const used = new Set(players.map(p=>p.role));
    Array.from(sel.options).forEach(opt=>{
        // Autoriser plusieurs 'Villageois' : ne pas désactiver cette option
        if(opt.value === 'Villageois') { opt.disabled = false; return; }
        // Désactiver les rôles déjà utilisés (sauf Villageois)
        if(opt.value && used.has(opt.value)) opt.disabled = true; else opt.disabled = false;
    });
}

// --- Cupidon: selection et mise en couple ---
function startCoupleSelection(cupidId){
    // créer overlay
    if(document.getElementById('coupleOverlay')) return;
    const overlay = document.createElement('div');
    overlay.id = 'coupleOverlay';
    overlay.style.position = 'fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background = 'rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';

    const box = document.createElement('div');
    box.style.background = '#fff'; box.style.padding='16px'; box.style.borderRadius='8px'; box.style.maxHeight='70%'; box.style.overflow='auto'; box.style.minWidth='320px';
    const title = document.createElement('div'); title.textContent = 'Sélectionner 2 joueurs à mettre en couple'; title.style.fontWeight='bold'; title.style.marginBottom='8px';
    box.appendChild(title);

    const list = document.createElement('div');
    players.filter(p=>p.alive && p.id !== cupidId).forEach(p=>{
        const row = document.createElement('div');
        row.style.marginBottom='6px';
        row.innerHTML = `<label><input type="checkbox" class="coupleChoice" value="${p.id}"> ${p.name} ${p.partnerId?'<span>❤️</span>':''}</label>`;
        list.appendChild(row);
    });
    box.appendChild(list);

    const help = document.createElement('div'); help.style.marginTop='8px'; help.textContent='Choisir exactement deux joueurs.'; box.appendChild(help);
    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>{overlay.remove();};
    const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const checked = Array.from(list.querySelectorAll('.coupleChoice:checked')).map(i=>i.value);
        if(checked.length !== 2){ alert('Sélectionnez exactement deux joueurs.'); return; }
            setCouple(checked[0], checked[1], cupidId);
        overlay.remove();
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions);

    overlay.appendChild(box); document.body.appendChild(overlay);
}

function setCouple(idA, idB, cupidId){
    const a = players.find(p=>p.id==idA); const b = players.find(p=>p.id==idB);
    if(!a || !b) { alert('Joueurs introuvables'); return; }
    // Défaire couples précédents
    if(a.partnerId){ const old = players.find(p=>p.id==a.partnerId); if(old) old.partnerId = undefined; }
    if(b.partnerId){ const old = players.find(p=>p.id==b.partnerId); if(old) old.partnerId = undefined; }
    a.partnerId = b.id; b.partnerId = a.id;
    // marquer l'utilisation de Cupidon
    if(cupidId){ const cup = players.find(p=>p.id==cupidId); if(cup) cup.cupidonUsed = true; }
    save(); render();
    alert(a.name + ' et ' + b.name + ' sont maintenant en couple ❤️');
}

function save() {
    localStorage.setItem("lg_players", JSON.stringify(players));
}

function updateNightDisplay(){
    const d = document.getElementById('nightDisplay'); if(d) d.textContent = String(currentNight);
}

function nextNight(){
    currentNight += 1; saveNight(); updateNightDisplay(); alert('Nuit '+currentNight+' commencée');
}

function resetNight(){
    if(!confirm('Réinitialiser la nuit à 1 ?')) return;
    currentNight = 1; saveNight(); updateNightDisplay();
}

// Assurer que chaque joueur a un ID unique
function ensurePlayerIds() {
    players.forEach((p, i) => {
        if (!p.id) p.id = Date.now() + i;
    });
}

// Trier selon l'ordre et la case Première nuit
function render() {
    ensurePlayerIds();
    updateNightDisplay();
    const div = document.getElementById("list");
    div.innerHTML = "";

    // Appliquer filtres
    const q = document.getElementById('search') ? document.getElementById('search').value.trim().toLowerCase() : '';
    const roleFilter = document.getElementById('roleFilter') ? document.getElementById('roleFilter').value : '';

    // Séparer morts et vivants
    const alive = players.filter(p => p.alive);
    const dead = players.filter(p => !p.alive);

    // Trier vivants selon ROLE_ORDER
    alive.sort((a,b)=>{
        const campA = ROLE_TO_CAMP[a.role] || 'Villageois';
        const campB = ROLE_TO_CAMP[b.role] || 'Villageois';
        const orderCampA = CAMP_ORDER.indexOf(campA);
        const orderCampB = CAMP_ORDER.indexOf(campB);
        if(orderCampA !== orderCampB) return orderCampA - orderCampB;
        // même camp -> fallback sur ROLE_ORDER
        const orderA = ROLE_ORDER.indexOf(a.role);
        const orderB = ROLE_ORDER.indexOf(b.role);
        if(a.firstNight && !b.firstNight) return 1;
        if(!a.firstNight && b.firstNight) return -1;
        return orderA - orderB;
    });

    function applyFilters(list){
        return list.filter(p=>{
            if(q && !p.name.toLowerCase().includes(q)) return false;
            if(roleFilter && roleFilter.length>0 && p.role !== roleFilter) return false;
            return true;
        });
    }

    const aliveFiltered = applyFilters(alive);
    const deadFiltered = applyFilters(dead);

    const all = [...aliveFiltered, ...deadFiltered];

    all.forEach((p)=>{
        const row = document.createElement("div");
        row.className = "player"+(p.alive?"":" dead");

        let firstNightCheckbox = "";
        // Affichage "Première nuit" seulement en bas à la nuit 2, pas ici
        // Mais ajouter un bouton pour marquer/démarquer
        if(["Chien-loup","Enfant sauvage","Vieux fou","Cupidon","Chasseur"].includes(p.role) && p.alive && currentNight === 1){
            firstNightCheckbox = `<button onclick="toggleFirstNight('${p.id}')" style="padding:2px 6px; font-size:12px;">${p.firstNight?'✓ Première nuit':'Première nuit'}</button>`;
        }

        let witchButtons = "";
        if(p.role==="Sorcière"){
            witchButtons = `
            <button onclick="useLifePotion('${p.id}')" ${p.lifePotionUsed?"disabled":""}>Potion Vie</button>
            <button onclick="useDeathPotion('${p.id}')" ${p.deathPotionUsed?"disabled":""}>Potion Mort</button>
            `;
        }

        let cupidonButton = "";
        if(p.role === 'Cupidon' && p.alive && !p.cupidonUsed){
            cupidonButton = `<button onclick="startCoupleSelection('${p.id}')">Mettre en couple</button>`;
        }

        let hunterButton = "";
        if(p.role === 'Chasseur' && p.alive){
            hunterButton = `<button onclick="seeChienLoup('${p.id}')">Voir Chien-loup</button>`;
        }

        let vieuxFouButton = "";
        if(p.role === 'Vieux fou' && p.alive && currentNight === 1 && !p.vieuxFouRole){
            vieuxFouButton = `<button onclick="chooseVieuxFouRole('${p.id}')">Choisir rôle</button>`;
        }

        let gardeButton = "";
        if(p.role === 'Garde' && p.alive){
            gardeButton = `<button onclick="startGuardProtection('${p.id}')">Protéger</button>`;
        }

        row.innerHTML = `
        <div>
            <b>${p.name}</b> ${p.partnerId?'<span title="En couple">❤️</span>':''}
            <div class="actions">
                <button onclick="actionSee('${p.id}')">Voir</button>
                ${firstNightCheckbox}
                ${witchButtons}
                ${cupidonButton}
                ${hunterButton}
                ${vieuxFouButton}
                ${gardeButton}
            </div>
        </div>
        <div>
            <button class="btn" onclick="toggleAlive('${p.id}')">${p.alive?"Tuer":"Réanimer"}</button>
            <button class="btn" onclick="del('${p.id}')">Supprimer</button>
        </div>
        `;
        div.appendChild(row);
    });

    // Afficher section "Première nuit" à partir de la nuit 2
    if(currentNight >= 2){
        const firstNightPlayers = players.filter(p=>p.firstNight && ["Chien-loup","Enfant sauvage","Vieux fou","Cupidon","Chasseur"].includes(p.role));
        if(firstNightPlayers.length > 0){
            const section = document.createElement('div');
            section.style.marginTop = '16px'; section.style.padding = '10px'; section.style.border = '2px solid #ff9800'; section.style.borderRadius = '6px'; section.style.backgroundColor = '#fff3e0';
            const title = document.createElement('div'); title.textContent = '⭐ Première nuit (ont agi la nuit 1)'; title.style.fontWeight = 'bold'; title.style.marginBottom = '8px'; section.appendChild(title);
            firstNightPlayers.forEach(p=>{
                const row = document.createElement('div'); row.style.marginBottom = '4px';
                row.innerHTML = `<b>${p.name}</b> (${p.role})`;
                section.appendChild(row);
            });
            div.appendChild(section);
        }
    }

    // mettre à jour disponibilité des rôles dans le select d'ajout
    updateRoleSelectAvailability();
}

// Ajouter joueur
function addPlayer(){
    const nameInput = document.getElementById("name");
    const roleSelect = document.getElementById("roleSelect");
    if(!nameInput.value.trim()) return;

    players.push({
        id: Date.now() + Math.floor(Math.random()*100000),
        name:nameInput.value.trim(),
        role:roleSelect.value,
        alive:true,
        firstNight:false,
        lifePotionUsed:false,
        deathPotionUsed:false,
        partnerId: undefined,
        cupidonUsed: false,
        vieuxFouRole: undefined,
        vieuxFouResurrected: false,
        croqueUses: 0,
        hiddenNight: undefined,
        deathNight: undefined,
        guardProtectedNight: undefined
    });

    nameInput.value="";
    save();
    render();
}

// Actions
function actionSee(id){ const p = players.find(x => x.id == id); alert(p.name+" est "+p.role); }
// Chasseur peut voir qui est le Chien-loup
function seeChienLoup(chasseurId){
    const ch = players.find(p=>p.id==chasseurId);
    if(!ch) return;
    const wolves = players.filter(p=>p.role === 'Chien-loup');
    if(wolves.length === 0){ alert('Aucun Chien-loup trouvé.'); return; }
    const names = wolves.map(w=>w.name + (w.alive ? '' : ' (mort)')).join(', ');
    alert('Chien-loup : ' + names);
}
function toggleAlive(id){
    const p = players.find(x => x.id == id);
    if(!p) return;
    // si on tente de tuer et que le joueur est protégé cette nuit, empêcher
    if(p.alive && p.guardProtectedNight === currentNight){
        alert(p.name + ' est protégé par le Garde cette nuit.');
        return;
    }
    p.alive = !p.alive;
    // si p vient de mourir, tuer aussi le partenaire
    if(p.alive === false && p.partnerId){
        const partner = players.find(x=>x.id == p.partnerId);
        if(partner && partner.alive){
            partner.alive = false;
            alert(partner.name + ' meurt aussi (partenaire de ' + p.name + ')');
        }
    }
    save(); render();
}

function del(id){
    // avant suppression, retirer lien de couple si existant
    const p = players.find(x=>x.id==id);
    if(p && p.partnerId){
        const partner = players.find(x=>x.id==p.partnerId);
        if(partner) partner.partnerId = undefined;
    }
    players = players.filter(x => x.id != id);
    save(); render();
}

function toggleFirstNight(id){
    const p = players.find(x => x.id == id);
    p.firstNight = !p.firstNight;
    save();
    render();
}

// Sorcière
function useLifePotion(id){
    const p = players.find(x => x.id == id);
    if(!p.lifePotionUsed){ p.lifePotionUsed=true; save(); render(); alert("Potion de vie utiliser"); }
}
function useDeathPotion(id){
    const p = players.find(x => x.id == id);
    if(!p.deathPotionUsed){; p.deathPotionUsed=true; save(); render(); alert("Potion de mort utiliser"); }
}

// --- Vieux fou ---
function chooseVieuxFouRole(vieuxId){
    const v = players.find(p=>p.id==vieuxId); if(!v) return;
    const choice = prompt('Choisir: tapez "Ancien" ou "Cinglé"');
    if(choice === 'Ancien' || choice === 'Cinglé'){
        v.vieuxFouRole = choice;
        save(); render();
        alert(v.name + ' est maintenant '+choice+'. Ressuscitera une fois si tué par ' + (choice==='Ancien'?'les loups':'le village') + '.');
    } else if(choice !== null){
        alert('Choix invalide. Tapez "Ancien" ou "Cinglé".');
    }
}

// --- Garde ---
function startGuardProtection(gardeId){
    if(document.getElementById('gardeOverlay')) return;
    const garde = players.find(p=>p.id==gardeId); if(!garde) return;
    const overlay = document.createElement('div'); overlay.id='gardeOverlay';
    overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
    overlay.style.background='rgba(0,0,0,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='12px'; box.style.borderRadius='8px'; box.style.minWidth='280px'; box.style.maxHeight='70%'; box.style.overflow='auto';
    const title = document.createElement('div'); title.textContent = 'Garde: protéger un joueur (nuit '+currentNight+')'; title.style.fontWeight='bold'; title.style.marginBottom='8px'; box.appendChild(title);

    const list = document.createElement('div');
    const targetable = players.filter(p=>p.alive && p.id !== gardeId);
    if(targetable.length === 0){ list.textContent = 'Aucun joueur à protéger.'; }
    targetable.forEach(p=>{
        const row = document.createElement('div'); row.style.marginBottom='6px';
        row.innerHTML = `<label><input type="radio" name="gardeChoice" value="${p.id}"> ${p.name}</label>`;
        list.appendChild(row);
    });
    box.appendChild(list);

    const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.textAlign='right';
    const cancel = document.createElement('button'); cancel.textContent='Annuler'; cancel.onclick = ()=>overlay.remove();
    const ok = document.createElement('button'); ok.textContent='Valider'; ok.style.marginLeft='8px'; ok.onclick = ()=>{
        const sel = box.querySelector('input[name="gardeChoice"]:checked'); if(!sel){ alert('Sélectionnez un joueur.'); return; }
        const targetId = sel.value;
        protectTarget(gardeId, targetId);
        overlay.remove();
    };
    actions.appendChild(cancel); actions.appendChild(ok); box.appendChild(actions);
    overlay.appendChild(box); document.body.appendChild(overlay);
}

function protectTarget(gardeId, targetId){
    const target = players.find(p=>p.id==targetId);
    if(!target) return;
    target.guardProtectedNight = currentNight;
    save(); render();
    alert(target.name + ' est protégé par le Garde pour la nuit ' + currentNight + '.');
}
</script>
</body>
</html>
